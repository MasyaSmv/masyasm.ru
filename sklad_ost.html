<?
$incRightBlock="users";
$msg="";
$activ="sklad_razm";
$menuname="Размещение остатков";
session_start();
setlocale(LC_ALL, 'ru_RU.CP1251');
include("$DOCUMENT_ROOT/users/user_fnc.php");
$statuses=array(0=>"не проверен",1=>"проверен и размещён", 2=>"проверен и отклонён", 3=>"устарел и будет удалён");
db_connect();
if(!isset($_SESSION['login']))
{
	header('Location: logon.html');
	exit;
}

require("$DOCUMENT_ROOT/users/user_activ.php");

$compname = ssql("select comp from users where id=$user_id");
$comp_id  = ssql("select company_id from users where id=$user_id");
$city     = ssql("select city from users where id = ".$_SESSION['panel_user_id']);


if($_SERVER['REQUEST_METHOD']=="POST"){
	if($_POST['newnamecomp']!=""){
		if($compname==""){
			$newnamecomp=mysql_real_escape_string($_POST['newnamecomp']);
			mysql_query("update users set comp='$newnamecomp' where id=$user_id limit 1");
			$compname=$newnamecomp;
			$msg="<h4 style='color: green'>Название организации успешно добавлено</h4>";
		}
	}else{
		//print_r($GLOBALS);exit;
		$error=0;

		if(!is_uploaded_file($_FILES['ufile']['tmp_name'])){
			$error++;
			$msg="<font color=red>Файл не закачан на сервер</font>";
		}

		if(!preg_match("/xls$/i",$_FILES['ufile']['name']) && !preg_match("/xlsx$/i",$_FILES['ufile']['name'])){
			$error++;
			$msg="<font color=red>Файл неверного формата</font>";
		}

		if($_POST['city'] == ''){
			$error++;
			$msg="<font color=red>Надо указать город</font>";
		}
		if($error==0){
			$ext="xls";
			if(substr($_FILES['ufile']['name'],-4)=="xlsx"){
				$ext="xlsx";
			}
			//принять файл, положить в каталог, занести в базу запись
			$tmpfname = tempnam("sklad_userfiles", date("Y.m.d").'_'.$user_id.'_');

			move_uploaded_file($_FILES['ufile']['tmp_name'],$tmpfname);
			$q="insert into sklad_userfiles set uid=$user_id, file='$tmpfname', date_cr='".date("Y-m-d H:i:s")."', status=0, ext='$ext'";
			mysql_query($q);
			$msg="<font color=green>Спасибо! Файл принят.<br>
			Информация в системе обновляется в течение одного рабочего дня с момента получения файла.
			</font>";
			if($city == ""){
				$city = mysql_real_escape_string(trim($_POST['city']));
				mysql_query("update users set city = '$city' where id =". $_SESSION['panel_user_id']);
			}
		}
	}
}else{



}
include("header.inc");



?>

<h1>Размещение остатков на сервисе СКЛАД</h1>
<?
if($msg!=""){

	print "<br><h2>$msg</h2></br>";

}
?>

<p>Сервис <a href="http://sklad.ruscable.ru/" target="_blank"><strong>СКЛАД</strong>.RusCable.Ru</a>&nbsp;&ndash; это поисковая система и база данных о наличии кабельно-проводниковой продукции в режиме реального времени на складах торгующих компаний в России и странах СНГ.</p>


<h2>Как разместить информацию о складских остатках Вашей компании:</h2>


<h3>Подготовьте файл формата Excel</h3>
<p>Файл должен иметь расширение .xls или .xlsx и содержать четыре колонки: <em>наименование</em>, <em>количество</em>, <em>единица измерения</em>, <em>остатки по кускам (если есть)</em>. Порядок столбцов должен быть именно таким, как на примере ниже.</p>
<p><img src="images/sklad_ost.jpg" width="481" height="245" border="0" alt="Файл формата Excel" style="padding: 5px 0;"></p>


<?
if($comp_id == 0){
?>
<h3 style="margin-top: 30px;">Добавьте информацию о Вашей организации</h3>
<p>Добавить информацию можно в разделе «<a href="http://www.ruscable.ru/users/company.html">Моя организация</a>».</p>
<?
}
?>


<h3 style="margin-top: 30px;">Отправьте нам подготовленную информацию</h3>

<p>Загрузите готовый файл, используя форму, расположенную ниже, или отправьте файл и карточку Вашей компании по адресу <a href="mailto:sklad@ruscable.ru">sklad@ruscable.ru</a>.</p>




<div style="display: inline-block; vertical-align: top; width: 45%; margin-right: 20px;">
<form method="POST" enctype="multipart/form-data" class='tform'>
<table  cellpadding="3" cellspacing="1" border="0" class="tblbord">
<tr class=tblth><td colspan=2>Форма для загрузки файла с информацией.</td></tr>
<?
if($city == ''){
	print "<tr class=tbltr><td width=30%>Укажите свой город:</td><td><input type=text name='city' style='width:200px;'></td></tr>";
}else{
	print "<tr class=tbltr><td width=30%>Город:</td><td><input type=text name='city' style='width:200px;' value='$city'></td></tr>";
}
?>
<tr class=tbltr><td width=30%>Загрузить файл:</td><td><input type=file name=ufile></td></tr>
<tr class=tblth><td colspan=2><input type=submit value='отправить'></td></tr>
</table>
<font color=red>*</font> <i>максимальный размер файла для загрузки = 15 Мб</i>
</form>
</div>


<div style="display: inline-block; vertical-align: top; width: 45%;">
<table  cellpadding="3" cellspacing="1" border="0" class="tblbord">
<tr class=tblth><td colspan=3>Ранее загруженные файлы:</td></tr>
<tr class=tblth><td width=30%>Дата загрузки</td><td>Статус</td><td>Комментарий администрации портала</td></tr>
<?
$q="select DATE_FORMAT( `date_cr` , '%d.%m.%Y' ), status, comment from sklad_userfiles where uid=$user_id order by date_cr desc limit 0,1";
$r=sql($q);
if(sizeof($r)>0){
	foreach($r as $rr){
		list($date_cr,$status,$comment)=$rr;
		print "<tr><td>$date_cr</td><td>".$statuses[$status]."</td><td>$comment</td></tr>";
	}
}else{
	print "<tr><td colspan=3>Файлы не найдены</td></tr>";
}
?>
</table>
</div>


<h3>Внимание!</h3>

<p>Присылать новую информацию о наличии на Вашем складе нужно не&nbsp;реже 1&nbsp;раза в две недели. Информация в нашей системе обновится в течение одного рабочего дня с момента получения нами Вашего файла.</p>
<p>После размещения складской справки на Ваш контактный e-mail (который Вы указали) поступит подтверждение о размещении. Далее все уведомления с рекомендацией о своевременном обновлении информации Вы также будете получать на указанный Вами e-mail.</p>
<p>Цель работы сервиса&nbsp;&ndash; предоставление Вашим потребителям самую свежую и актуальную информацию. Поэтому в случае предоставления недостоверных данных или задержки обновления информации сервис после второго предупреждения исключит Вашу организацию из базы.</p>



<div style='padding: 10px 20px; margin: 30px 0; border: 1px solid grey; border-radius: 10px;'>
<h2>УСТАНОВИТЕ НАШ ИНФОРМЕР НА ВАШ САЙТ</h2>
Бесплатный «<a href="http://www.ruscable.ru/users/sklad_informer.html" target="_blank">Склад on-line</a>»&nbsp;&ndash; это визуальное отображение краткой справки о состоянии складского наличия в реальном времени на Вашем сайте. Ссылка с информера ведет на Вашу страницу с данными на сервисе СКЛАД.RusCable.Ru. Наши механизмы поиска и оформления заявки ускорят процесс обращения к Вам. Кстати, на информере есть надпись «проверено RusCable.Ru». Она повысит уровень доверия к Вашей информации у Вашего потенциального клиента.

<a href="http://www.ruscable.ru/users/sklad_informer.html" target="_blank">Установите информер</a> прямо сейчас. Обратите внимание, что установить информер можно только при заполненных данных о компании и загруженной складской справке.
</div>





<?

include("footer.inc");

?>
